<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flask App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .greeting {
            color: #007bff;
        }
    </style>
</head>

<body>
    <div class="container">

        <h1>MyInvois JSON Signature Tool</h1>
        <p class="greeting"></p>

        <div class="row">
            <div class="col">
                <div class="card">
                    <div class="card-body">
                        <form id="form">
                            <div class="mb-3">
                                <label for="doc" class="form-label">Document JSON</label>
                                <textarea class="form-control" id="doc" rows="6" aria-describedby="docHelp" required>{"_D":"urn:oasis:names:specification:ubl:schema:xsd:Invoice-2","_A":"urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2","_B":"urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2","Invoice":[{"ID":[{"_":"705725225958"}],"IssueDate":[{"_":"2024-11-26"}],"IssueTime":[{"_":"00:21:50Z"}],"InvoiceTypeCode":[{"_":"01","listVersionID":"1.1"}],"DocumentCurrencyCode":[{"_":"MYR"}],"InvoicePeriod":[{"StartDate":[{"_":""}],"EndDate":[{"_":""}],"Description":[{"_":""}]}],"BillingReference":[{"AdditionalDocumentReference":[{"ID":[{"_":"1234"}]}]}],"AdditionalDocumentReference":[{"ID":[{"_":"762673792005"}]}],"AccountingSupplierParty":[{"AdditionalAccountID":[{"_":"","schemeAgencyName":"CertEx"}],"Party":[{"IndustryClassificationCode":[{"_":"61902","name":"Provision of telecommunications services over existing telecom connection"}],"PartyIdentification":[{"ID":[{"_":"C20839371040","schemeID":"TIN"}]},{"ID":[{"_":"200601000306","schemeID":"BRN"}]},{"ID":[{"_":"02332234234343","schemeID":"SST"}]},{"ID":[{"_":"03434234342343432","schemeID":"TTX"}]}],"PostalAddress":[{"CityName":[{"_":"ASAJAYA"}],"PostalZone":[{"_":"94600"}],"CountrySubentityCode":[{"_":"01"}],"AddressLine":[{"Line":[{"_":"Line 1"}]},{"Line":[{"_":"Line 2"}]},{"Line":[{"_":"Line 3"}]}],"Country":[{"IdentificationCode":[{"_":"MYS","listID":"3166-1","listAgencyID":"ISO"}]}]}],"PartyLegalEntity":[{"RegistrationName":[{"_":"SMJ TERATAI SDN. BHD."}]}],"Contact":[{"Telephone":[{"_":"0123456789"}],"ElectronicMail":[{"_":"einvoice_smjteratai@smjremit.com"}]}]}]}],"AccountingCustomerParty":[{"Party":[{"PartyIdentification":[{"ID":[{"_":"IG21062484010","schemeID":"TIN"}]},{"ID":[{"_":"850812136079","schemeID":"NRIC"}]}],"PostalAddress":[{"CityName":[{"_":"SEMUA NEGERI"}],"PostalZone":[{"_":"81500"}],"CountrySubentityCode":[{"_":"00"}],"AddressLine":[{"Line":[{"_":"buyerAddressLine1"}]},{"Line":[{"_":"buyerAddressLine2"}]},{"Line":[{"_":""}]}],"Country":[{"IdentificationCode":[{"_":"MYS","listID":"3166-1","listAgencyID":"ISO"}]}]}],"PartyLegalEntity":[{"RegistrationName":[{"_":"BuyerName"}]}],"Contact":[{"Telephone":[{"_":"123456789012"}],"ElectronicMail":[{"_":"Buyer@gmail.com"}]}]}]}],"Delivery":[{"DeliveryParty":[{"PartyLegalEntity":[{"RegistrationName":[{"_":""}]}],"PostalAddress":[{"CityName":[{"_":""}],"PostalZone":[{"_":""}],"CountrySubentityCode":[{"_":""}],"AddressLine":[{"Line":[{"_":""}]},{"Line":[{"_":""}]},{"Line":[{"_":""}]}],"Country":[{"IdentificationCode":[{"_":"","listID":"","listAgencyID":""}]}]}],"PartyIdentification":[{"ID":[{"_":"","schemeID":""}]}]}],"Shipment":[{"ID":[{"_":""}],"FreightAllowanceCharge":[{"ChargeIndicator":[{"_":true}],"AllowanceChargeReason":[{"_":""}],"Amount":[{"_":0,"currencyID":"MYR"}]}]}]}],"PaymentMeans":[{"PaymentMeansCode":[{"_":""}],"PayeeFinancialAccount":[{"ID":[{"_":""}]}]}],"PaymentTerms":[{"Note":[{"_":""}]}],"PrepaidPayment":[{"ID":[{"_":""}],"PaidAmount":[{"_":0,"currencyID":"MYR"}],"PaidDate":[{"_":""}],"PaidTime":[{"_":""}]}],"AllowanceCharge":[{"ChargeIndicator":[{"_":true}],"AllowanceChargeReason":[{"_":""}],"Amount":[{"_":0,"currencyID":"MYR"}]},{"ChargeIndicator":[{"_":false}],"AllowanceChargeReason":[{"_":""}],"Amount":[{"_":0,"currencyID":"MYR"}]}],"TaxTotal":[{"TaxAmount":[{"_":15680,"currencyID":"MYR"}],"TaxSubtotal":[{"TaxableAmount":[{"_":784000,"currencyID":"MYR"}],"TaxAmount":[{"_":15680,"currencyID":"MYR"}],"TaxCategory":[{"ID":[{"_":"02"}],"TaxScheme":[{"ID":[{"_":"OTH","schemeAgencyID":"6","schemeID":"UN/ECE 5153"}]}]}]}]}],"LegalMonetaryTotal":[{"LineExtensionAmount":[{"_":784000,"currencyID":"MYR"}],"TaxExclusiveAmount":[{"_":784000,"currencyID":"MYR"}],"TaxInclusiveAmount":[{"_":799680,"currencyID":"MYR"}],"AllowanceTotalAmount":[{"_":0,"currencyID":"MYR"}],"ChargeTotalAmount":[{"_":0,"currencyID":"MYR"}],"PayableAmount":[{"_":799680,"currencyID":"MYR"}],"PayableRoundingAmount":[{"_":0,"currencyID":"MYR"}]}],"InvoiceLine":[{"AllowanceCharge":[{"Amount":[{"_":16000,"currencyID":"MYR"}],"ChargeIndicator":[{"_":false}],"MultiplierFactorNumeric":[{"_":2}],"AllowanceChargeReason":[{"_":"Reason"}]}],"ID":[{"_":"1"}],"InvoicedQuantity":[{"_":80,"unitCode":"KAT"}],"Item":[{"CommodityClassification":[{"ItemClassificationCode":[{"_":"002","listID":"CLASS"}]}],"Description":[{"_":"Product"}],"OriginCountry":[{"IdentificationCode":[{"_":""}]}]}],"ItemPriceExtension":[{"Amount":[{"_":800000,"currencyID":"MYR"}]}],"LineExtensionAmount":[{"_":784000,"currencyID":"MYR"}],"Price":[{"PriceAmount":[{"_":10000,"currencyID":"MYR"}]}],"TaxTotal":[{"TaxAmount":[{"_":15680,"currencyID":"MYR"}],"TaxSubtotal":[{"TaxableAmount":[{"_":784000,"currencyID":"MYR"}],"TaxAmount":[{"_":15680,"currencyID":"MYR"}],"Percent":[{"_":2}],"TaxCategory":[{"ID":[{"_":"02"}],"TaxScheme":[{"ID":[{"_":"OTH","schemeAgencyID":"6","schemeID":"UN/ECE 5153"}]}]}]}]}]},{"AllowanceCharge":[{"Amount":[{"_":16000,"currencyID":"MYR"}],"ChargeIndicator":[{"_":false}],"MultiplierFactorNumeric":[{"_":2}],"AllowanceChargeReason":[{"_":"Reason"}]}],"ID":[{"_":"2"}],"InvoicedQuantity":[{"_":80,"unitCode":"KAT"}],"Item":[{"CommodityClassification":[{"ItemClassificationCode":[{"_":"003","listID":"CLASS"}]}],"Description":[{"_":"Product"}],"OriginCountry":[{"IdentificationCode":[{"_":""}]}]}],"ItemPriceExtension":[{"Amount":[{"_":800000,"currencyID":"MYR"}]}],"LineExtensionAmount":[{"_":784000,"currencyID":"MYR"}],"Price":[{"PriceAmount":[{"_":10000,"currencyID":"MYR"}]}],"TaxTotal":[{"TaxAmount":[{"_":15680,"currencyID":"MYR"}],"TaxSubtotal":[{"TaxableAmount":[{"_":784000,"currencyID":"MYR"}],"TaxAmount":[{"_":15680,"currencyID":"MYR"}],"Percent":[{"_":2}],"TaxCategory":[{"ID":[{"_":"02"}],"TaxScheme":[{"ID":[{"_":"OTH","schemeAgencyID":"6","schemeID":"UN/ECE 5153"}]}]}]}]}]}],"TaxExchangeRate":[{"SourceCurrencyCode":[{"_":"MYR"}],"TargetCurrencyCode":[{"_":"MYR"}],"CalculationRate":[{"_":0}]}]}]}</textarea>
                                <div id="docHelp" class="form-text">Base json document, which you wanna sign using cert</div>
                            </div>
                            <div class="mb-3 border border-secondary rounded p-3">
                                <label for="minifiedDoc" class="form-label">Minified String</label>
                                <input class="form-control" id="minifiedDoc" name="doc" type="text" placeholder="Auto-fill" value=""  aria-describedby="mDocHelp" readonly>
                            </div>
                            <div class="mb-3">
                                <label for="cert" class="form-label">Choose Certificate</label>
                                <select class="form-select form-select-sm" id="cert" aria-describedby="certHelp" required>
                                </select>
                                <div id="certHelp" class="form-text">Upload *.p12 certificate in <code>cert/</code></div>
                            </div>
                            <div class="mb-3">
                                <label for="certpass" class="form-label">Certificate Passkey</label>
                                <input type="text" class="form-control" id="certpass" name="pass" value="Kb0!k#Qv" required>
                            </div>
                            <div class="">
                                <button id="sign" type="submit" class="btn btn-outline-primary">Sign Document</button>
                            </div>
                        </form>
                    </div>
                    <div class="card-footer text-body-secondary">
                        2 days ago
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card">
                    <div class="card-body">
                        <form id="form2">
                            <div class="mb-3">
                                <label for="signedDoc" class="form-label">Signed JSON</label>
                                <textarea class="form-control" id="signedDoc" rows="6" aria-describedby="signedDocHelp"></textarea>
                                <div id="signedDocHelp" class="form-text">Final signed document</div>
                            </div>
                            <div class="mb-3 border border-primary rounded p-3">
                                <label for="hash" class="form-label">DocHash (SHA256)</label>
                                <input class="form-control" id="hash" type="text" placeholder="" value="" readonly>
                            </div>
                            <div class="mb-3 border border-primary rounded p-3">
                                <label for="digest" class="form-label">Document (Base64)</label>
                                <input class="form-control" id="digest" type="text" placeholder="" value="" readonly>
                            </div>
                        </form>
                    </div>
                    <div class="card-footer text-body-secondary">
                        2 days ago
                    </div>
                </div>
            </div>
        </div>
        

        

    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"></script>
    <script>
        function makeRequest(url, method = 'GET', body = null, timeout = 5000) {
            // Set up the fetch options based on the method
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
            };

            // If it's a POST request, include the body
            if (method === 'POST' && body) {
                options.body = JSON.stringify(body);
            }

            // Create a timeout promise
            const timeoutPromise = new Promise((_, reject) =>
                setTimeout(() => reject(new Error('Request timed out')), timeout)
            );

            // Make the fetch request with the timeout
            return Promise.race([
                fetch(url, options)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json(); // Assuming the response is in JSON format
                    })
                    .catch(error => {
                        throw new Error(`Network or parsing error: ${error.message}`);
                    }),
                timeoutPromise // If the fetch takes too long, the timeout promise will reject
            ])
            .then(data => {
                return data; // Successfully parsed JSON response
            })
            .catch(error => {
                // Handle all errors here (timeout, network error, invalid JSON, etc.)
                console.error('Request failed:', error.message);
                throw error; // Re-throw the error if needed
            });
        }

        function minifyJson(jsonString) {
            try {
                const jsonObject = JSON.parse(jsonString);
                const minifiedJson = JSON.stringify(jsonObject);
                return minifiedJson
            } catch (error) {
                // console.error('Invalid JSON: ' + error.message);
            }
        }

        makeRequest('/api/getcerts')
            .then(data => {
                // Assuming the response data is an array of objects with 'id' and 'name' properties
                const selectElement = document.getElementById('cert');
                selectElement.innerHTML = ''; // Clear existing options

                data.forEach(cert => {
                    const option = document.createElement('option');
                    option.value = cert;  // Assuming 'id' is the value for each option
                    option.textContent = cert;  // Assuming 'name' is the text to display
                    selectElement.appendChild(option);
                });
            })
            .catch(error => alert('API Error:', error.message));

        document.getElementById('doc').addEventListener('input', function() {
            const jsonString = this.value;
            
        });
        document.getElementById('minifiedDoc').value = minifyJson(document.getElementById('doc').value);

        document.getElementById('form').addEventListener('submit', function(event) {
            // Prevent the default form submission (page reload)
            event.preventDefault();

            const minifiedDoc = document.getElementById('minifiedDoc').value;
            const cert = document.getElementById('cert').value;
            const pass = document.getElementById('certpass').value;

            const data = {
                doc: minifiedDoc,
                cert: cert,
                pass: pass
            };

            if (!minifiedDoc.length || !cert.length || !pass.length) {
                alert("Please fill all required values");
                return;
            }

            makeRequest('/api/signdoc', 'POST', data)
                .then(data => {
                    // Assuming the response data is an array of objects with 'id' and 'name' properties
                    const selectElement = document.getElementById('cert');
                    selectElement.innerHTML = ''; // Clear existing options

                    data.forEach(cert => {
                        const option = document.createElement('option');
                        option.value = cert;  // Assuming 'id' is the value for each option
                        option.textContent = cert;  // Assuming 'name' is the text to display
                        selectElement.appendChild(option);
                    });
                })
                .catch(error => alert('CertFetch Error:', error.message));
        })
    </script>
</body>

</html>